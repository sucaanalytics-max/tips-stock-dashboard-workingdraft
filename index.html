<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tips Music Analytics Dashboard | YouTube & Stock Correlation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
        }

        .dashboard-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .dashboard-header p {
            opacity: 0.95;
            font-size: 1.1rem;
        }

        .filters-container {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 180px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input[type="date"] {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        select:hover, input[type="date"]:hover {
            border-color: var(--primary);
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .metric-change {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .metric-change.positive {
            color: var(--success);
        }

        .metric-change.negative {
            color: var(--danger);
        }

        .charts-grid {
            display: grid;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .chart-toggle {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--card-bg);
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .chart-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .chart-toggle.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-color: transparent;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .chart-wrapper.large {
            height: 500px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .table-container {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px 25px;
            border-bottom: 2px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
        }

        th {
            background: var(--background);
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: var(--background);
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-top: 2px solid var(--border);
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: var(--card-bg);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: var(--primary);
            color: var(--primary);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .footer-time {
            font-weight: 600;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }

            .dashboard-header h1 {
                font-size: 1.5rem;
            }

            .filters-container {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .chart-wrapper {
                height: 300px;
            }

            .chart-wrapper.large {
                height: 350px;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px;
            }
        }

        .error-message {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c00;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1>üìä Tips Music Analytics Dashboard</h1>
            <p>YouTube Performance & NSE Stock Correlation Analysis</p>
        </div>

        <!-- Filters -->
        <div class="filters-container">
            <div class="filter-group">
                <label>Time Period</label>
                <select id="timeRange" onchange="updateDateRange()">
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                    <option value="365" selected>Last 1 Year</option>
                    <option value="all">All Time (2023-Present)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>From Date</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label>To Date</label>
                <input type="date" id="endDate">
            </div>
            <div class="filter-group">
                <button class="btn btn-primary" onclick="loadDashboardData()">üîÑ Refresh Data</button>
            </div>
        </div>

        <!-- Error Message (hidden by default) -->
        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total Subscribers</div>
                <div class="metric-value" id="totalSubscribers">--</div>
                <div class="metric-change" id="subscribersChange">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Total Views</div>
                <div class="metric-value" id="totalViews">--</div>
                <div class="metric-change" id="viewsChange">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Daily Views (Latest)</div>
                <div class="metric-value" id="dailyViews">--</div>
                <div class="metric-change" id="dailyViewsChange">Loading...</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Stock Price (Latest)</div>
                <div class="metric-value" id="stockPrice">--</div>
                <div class="metric-change" id="stockPriceChange">Loading...</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <!-- Daily Views Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">üìà Daily Views - Tips Music</h3>
                    <div class="chart-controls">
                        <button class="chart-toggle active" onclick="toggleDailyViewsScale('linear')">Linear</button>
                        <button class="chart-toggle" onclick="toggleDailyViewsScale('log')">Logarithmic</button>
                        <button class="chart-toggle" onclick="toggleDailyViewsMA()">Show MA (7/30/45)</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="dailyViewsChart"></canvas>
                </div>
            </div>

            <!-- Stock Price Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">üíπ Stock Price - NSE: TIPSMUSIC</h3>
                    <div class="chart-controls">
                        <button class="chart-toggle active" onclick="toggleStockScale('linear')">Linear</button>
                        <button class="chart-toggle" onclick="toggleStockScale('log')">Logarithmic</button>
                        <button class="chart-toggle" onclick="toggleStockMA()">Show MA (7/30/45)</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>

            <!-- Monthly Growth Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">üìä Monthly Views Growth</h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="monthlyGrowthChart"></canvas>
                </div>
            </div>

            <!-- Comparison Chart (Dual-Axis) -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">üîó Daily Views vs Stock Price (Dual-Axis)</h3>
                    <div class="chart-controls">
                        <button class="chart-toggle active" onclick="toggleComparisonMode('raw')">Raw Daily Views</button>
                        <button class="chart-toggle" onclick="toggleComparisonMode('ma30')">30-Day MA</button>
                        <button class="chart-toggle" onclick="toggleComparisonMode('ma45')">45-Day MA</button>
                        <button class="chart-toggle" onclick="toggleComparisonMode('stock45')">45-DMA Stock</button>
                    </div>
                </div>
                <div class="chart-wrapper large">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="chart-title">üìã Daily Channel Metrics</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Daily Views</th>
                        <th>Change</th>
                        <th>% Change</th>
                        <th>Stock Price (‚Çπ)</th>
                        <th>Stock Change</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="6" class="loading">Loading data...</td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination">
                <div class="pagination-info" id="paginationInfo">Showing 0-0 of 0 records</div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="previousPage()" id="prevBtn">‚Üê Previous</button>
                    <button class="pagination-btn" onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Last updated: <span class="footer-time" id="lastUpdated">--</span></p>
            <p style="margin-top: 10px; color: var(--text-secondary);">
                Data source: Supabase PostgreSQL | Stock: NSE TIPSMUSIC
            </p>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        // Global state
        let dashboardData = {
            tipsDaily: [],
            stockPrices: [],
            monthlyData: []
        };

        let charts = {
            dailyViews: null,
            stock: null,
            monthlyGrowth: null,
            comparison: null
        };

        let chartSettings = {
            dailyViewsScale: 'linear',
            stockScale: 'linear',
            dailyViewsShowMA: false,
            stockShowMA: false
        };

        let comparisonMode = 'raw'; // 'raw', 'ma30', 'ma45', 'stock45'

        let currentPage = 1;
        const rowsPerPage = 20;

        // ============================================================
        // DATA FETCHING
        // ============================================================

        async function fetchSupabaseData(endpoint, params = {}) {
            const url = new URL(`${SUPABASE_URL}/rest/v1/${endpoint}`);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

            const response = await fetch(url, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        async function loadDashboardData() {
            try {
                showError('');
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                // Fetch Tips daily data
                const tipsDaily = await fetchSupabaseData('daily_label_totals', {
                    'label': 'eq.Tips',
                    'date': `gte.${startDate}`,
                    'date': `lte.${endDate}`,
                    'order': 'date.desc',
                    'limit': 2000
                });

                // Fetch stock prices
                const stockPrices = await fetchSupabaseData('stock_prices', {
                    'symbol': 'eq.TIPSMUSIC',
                    'date': `gte.${startDate}`,
                    'date': `lte.${endDate}`,
                    'order': 'date.desc',
                    'limit': 2000
                });

                // Fetch monthly data
                const monthlyData = await fetchSupabaseData('monthly_label_totals', {
                    'label': 'eq.Tips',
                    'order': 'month.desc',
                    'limit': 24
                });

                dashboardData = {
                    tipsDaily: tipsDaily.reverse(),
                    stockPrices: stockPrices.reverse(),
                    monthlyData: monthlyData.reverse()
                };

                updateDashboard();
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load data: ' + error.message);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        // ============================================================
        // DASHBOARD UPDATES
        // ============================================================

        function updateDashboard() {
            updateMetrics();
            updateDailyViewsChart();
            updateStockChart();
            updateMonthlyGrowthChart();
            updateComparisonChart();
            updateDataTable();
        }

        function updateMetrics() {
            const { tipsDaily, stockPrices } = dashboardData;

            if (tipsDaily.length === 0) return;

            const latest = tipsDaily[tipsDaily.length - 1];
            const previous = tipsDaily.length > 1 ? tipsDaily[tipsDaily.length - 2] : latest;

            // Total Subscribers
            document.getElementById('totalSubscribers').textContent = formatNumber(latest.total_subscribers);
            const subsChange = latest.total_subscribers - previous.total_subscribers;
            updateChangeElement('subscribersChange', subsChange);

            // Total Views
            document.getElementById('totalViews').textContent = formatNumber(latest.total_views);
            const viewsChange = latest.total_views - previous.total_views;
            updateChangeElement('viewsChange', viewsChange);

            // Daily Views
            document.getElementById('dailyViews').textContent = formatNumber(latest.daily_views || 0);
            const dailyChange = (latest.daily_views || 0) - (previous.daily_views || 0);
            updateChangeElement('dailyViewsChange', dailyChange, true);

            // Stock Price
            if (stockPrices.length > 0) {
                const latestStock = stockPrices[stockPrices.length - 1];
                const previousStock = stockPrices.length > 1 ? stockPrices[stockPrices.length - 2] : latestStock;
                
                document.getElementById('stockPrice').textContent = `‚Çπ${latestStock.close.toFixed(2)}`;
                const stockChange = latestStock.close - previousStock.close;
                const stockChangePct = (stockChange / previousStock.close * 100).toFixed(2);
                
                const changeEl = document.getElementById('stockPriceChange');
                changeEl.textContent = `${stockChange >= 0 ? '‚ñ≤' : '‚ñº'} ‚Çπ${Math.abs(stockChange).toFixed(2)} (${stockChangePct}%)`;
                changeEl.className = 'metric-change ' + (stockChange >= 0 ? 'positive' : 'negative');
            }
        }

        function updateChangeElement(elementId, change, isDaily = false) {
            const element = document.getElementById(elementId);
            const arrow = change >= 0 ? '‚ñ≤' : '‚ñº';
            const className = change >= 0 ? 'positive' : 'negative';
            
            if (isDaily) {
                element.textContent = `${arrow} ${formatNumber(Math.abs(change))} views`;
            } else {
                element.textContent = `${arrow} ${formatNumber(Math.abs(change))}`;
            }
            
            element.className = 'metric-change ' + className;
        }

        // ============================================================
        // CHART UPDATES
        // ============================================================

        function updateDailyViewsChart() {
            const { tipsDaily } = dashboardData;
            
            const dates = tipsDaily.map(d => d.date);
            const dailyViews = tipsDaily.map(d => d.daily_views || 0);

            const datasets = [{
                label: 'Daily Views',
                data: dailyViews,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2.5,
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 5
            }];

            if (chartSettings.dailyViewsShowMA) {
                datasets.push(
                    {
                        label: '7-Day MA',
                        data: calculateSMA(dailyViews, 7),
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    },
                    {
                        label: '30-Day MA',
                        data: calculateSMA(dailyViews, 30),
                        borderColor: '#10b981',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    },
                    {
                        label: '45-Day MA',
                        data: calculateSMA(dailyViews, 45),
                        borderColor: '#ef4444',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    }
                );
            }

            if (charts.dailyViews) charts.dailyViews.destroy();

            charts.dailyViews = new Chart(document.getElementById('dailyViewsChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: getChartOptions('Daily Views', chartSettings.dailyViewsScale)
            });
        }

        function updateStockChart() {
            const { stockPrices } = dashboardData;
            
            const dates = stockPrices.map(d => d.date);
            const closePrices = stockPrices.map(d => d.close);

            const datasets = [{
                label: 'Stock Price (‚Çπ)',
                data: closePrices,
                borderColor: '#764ba2',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                borderWidth: 2.5,
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 5
            }];

            if (chartSettings.stockShowMA) {
                datasets.push(
                    {
                        label: '7-Day MA',
                        data: calculateSMA(closePrices, 7),
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    },
                    {
                        label: '30-Day MA',
                        data: calculateSMA(closePrices, 30),
                        borderColor: '#10b981',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    },
                    {
                        label: '45-Day MA',
                        data: calculateSMA(closePrices, 45),
                        borderColor: '#ef4444',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        borderDash: [5, 5]
                    }
                );
            }

            if (charts.stock) charts.stock.destroy();

            charts.stock = new Chart(document.getElementById('stockChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: getChartOptions('Stock Price (‚Çπ)', chartSettings.stockScale)
            });
        }

        function updateMonthlyGrowthChart() {
            const { monthlyData } = dashboardData;
            
            const months = monthlyData.map(d => d.month);
            const growth = monthlyData.map(d => d.mom_views_growth_pct || 0);

            if (charts.monthlyGrowth) charts.monthlyGrowth.destroy();

            charts.monthlyGrowth = new Chart(document.getElementById('monthlyGrowthChart'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Month-over-Month Views Growth (%)',
                        data: growth,
                        backgroundColor: growth.map(g => g >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                        borderColor: growth.map(g => g >= 0 ? '#10b981' : '#ef4444'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Growth: ${context.parsed.y.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateComparisonChart() {
            const { tipsDaily, stockPrices } = dashboardData;
            
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            const filteredDaily = tipsDaily.filter(d => {
                const date = new Date(d.date);
                return date >= startDate && date <= endDate;
            });

            const filteredStock = stockPrices.filter(s => {
                const date = new Date(s.date);
                return date >= startDate && date <= endDate && s.close > 0;
            });

            const dates = filteredDaily.map(d => d.date);
            const dailyViews = filteredDaily.map(d => d.daily_views || 0);

            let viewsData = dailyViews;
            let viewsLabel = 'Daily Views';
            let stockData = null;
            let stockLabel = 'Stock Price (‚Çπ)';

            // ‚úÖ UPDATED: Handle different comparison modes
            if (comparisonMode === 'ma30') {
                viewsData = calculateSMA(dailyViews, 30);
                viewsLabel = '30-Day MA (Daily Views)';
            } else if (comparisonMode === 'ma45') {
                viewsData = calculateSMA(dailyViews, 45);
                viewsLabel = '45-Day MA (Daily Views)';
            } else if (comparisonMode === 'stock45') {
                // ‚úÖ NEW: Show 45-DMA for stock price
                const stockPriceData = dates.map(date => {
                    const stock = filteredStock.find(s => s.date === date);
                    return stock ? stock.close : null;
                });
                const stockPriceDataFilled = forwardFill(stockPriceData);
                stockData = calculateSMA(stockPriceDataFilled, 45);
                stockLabel = '45-Day MA (Stock Price ‚Çπ)';
            }

            // Forward-fill stock prices to remove gaps
            const stockPriceData = dates.map(date => {
                const stock = filteredStock.find(s => s.date === date);
                return stock ? stock.close : null;
            });

            const stockPriceDataFilled = forwardFill(stockPriceData);

            // Use calculated stock MA if in stock45 mode, otherwise use raw stock price
            const finalStockData = comparisonMode === 'stock45' ? stockData : stockPriceDataFilled;

            const primaryColor = '#667eea';
            const secondaryColor = '#764ba2';
            const gridColor = '#e9ecef';
            const textColor = '#5a6c7d';

            if (charts.comparison) charts.comparison.destroy();

            charts.comparison = new Chart(document.getElementById('comparisonChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: viewsLabel,
                            data: viewsData,
                            borderColor: primaryColor,
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2.5,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            pointHoverBackgroundColor: primaryColor,
                            pointHoverBorderColor: 'white',
                            pointHoverBorderWidth: 2
                        },
                        {
                            label: stockLabel,
                            data: finalStockData,
                            borderColor: secondaryColor,
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            borderWidth: 2.5,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            pointHoverBackgroundColor: secondaryColor,
                            pointHoverBorderColor: 'white',
                            pointHoverBorderWidth: 2,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 12,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.datasetIndex === 0) {
                                            label += formatNumber(context.parsed.y);
                                        } else {
                                            label += '‚Çπ' + context.parsed.y.toFixed(2);
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            ticks: {
                                color: textColor,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: viewsLabel,
                                color: primaryColor,
                                font: {
                                    weight: '600'
                                }
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: stockLabel,
                                color: secondaryColor,
                                font: {
                                    weight: '600'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ============================================================
        // CHART HELPERS
        // ============================================================

        function getChartOptions(yAxisLabel, scaleType = 'linear') {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: {
                        type: scaleType,
                        beginAtZero: scaleType === 'linear',
                        title: {
                            display: true,
                            text: yAxisLabel
                        },
                        ticks: {
                            callback: function(value) {
                                if (yAxisLabel.includes('‚Çπ')) {
                                    return '‚Çπ' + value.toFixed(0);
                                }
                                return formatNumber(value);
                            }
                        }
                    }
                }
            };
        }

        function calculateSMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / period);
                }
            }
            return result;
        }

        function forwardFill(data) {
            const result = [...data];
            let lastValue = null;
            
            for (let i = 0; i < result.length; i++) {
                if (result[i] !== null) {
                    lastValue = result[i];
                } else if (lastValue !== null) {
                    result[i] = lastValue;
                }
            }
            
            return result;
        }

        // ============================================================
        // CHART TOGGLES
        // ============================================================

        function toggleDailyViewsScale(scale) {
            chartSettings.dailyViewsScale = scale;
            updateDailyViewsChart();

            const container = document.getElementById('dailyViewsChart').closest('.chart-container');
            container.querySelectorAll('.chart-toggle').forEach(btn => {
                if (btn.textContent.includes('Linear') || btn.textContent.includes('Logarithmic')) {
                    btn.classList.remove('active');
                    if ((scale === 'linear' && btn.textContent.includes('Linear')) ||
                        (scale === 'log' && btn.textContent.includes('Logarithmic'))) {
                        btn.classList.add('active');
                    }
                }
            });
        }

        function toggleStockScale(scale) {
            chartSettings.stockScale = scale;
            updateStockChart();

            const container = document.getElementById('stockChart').closest('.chart-container');
            container.querySelectorAll('.chart-toggle').forEach(btn => {
                if (btn.textContent.includes('Linear') || btn.textContent.includes('Logarithmic')) {
                    btn.classList.remove('active');
                    if ((scale === 'linear' && btn.textContent.includes('Linear')) ||
                        (scale === 'log' && btn.textContent.includes('Logarithmic'))) {
                        btn.classList.add('active');
                    }
                }
            });
        }

        function toggleDailyViewsMA() {
            chartSettings.dailyViewsShowMA = !chartSettings.dailyViewsShowMA;
            updateDailyViewsChart();

            const container = document.getElementById('dailyViewsChart').closest('.chart-container');
            const btn = Array.from(container.querySelectorAll('.chart-toggle')).find(b => b.textContent.includes('Show MA'));
            if (btn) {
                btn.classList.toggle('active');
            }
        }

        function toggleStockMA() {
            chartSettings.stockShowMA = !chartSettings.stockShowMA;
            updateStockChart();

            const container = document.getElementById('stockChart').closest('.chart-container');
            const btn = Array.from(container.querySelectorAll('.chart-toggle')).find(b => b.textContent.includes('Show MA'));
            if (btn) {
                btn.classList.toggle('active');
            }
        }

        function toggleComparisonMode(mode) {
            comparisonMode = mode;
            updateComparisonChart();

            const container = document.getElementById('comparisonChart').closest('.chart-container');
            container.querySelectorAll('.chart-toggle').forEach(btn => {
                btn.classList.remove('active');
                if ((mode === 'raw' && btn.textContent.includes('Raw')) ||
                    (mode === 'ma30' && btn.textContent.includes('30-Day')) ||
                    (mode === 'ma45' && btn.textContent.includes('45-Day') && !btn.textContent.includes('Stock')) ||
                    (mode === 'stock45' && btn.textContent.includes('45-DMA Stock'))) {
                    btn.classList.add('active');
                }
            });
        }

        // ============================================================
        // DATA TABLE
        // ============================================================

        function updateDataTable() {
            const { tipsDaily, stockPrices } = dashboardData;
            
            const merged = tipsDaily.map(d => {
                const stock = stockPrices.find(s => s.date === d.date);
                return {
                    date: d.date,
                    dailyViews: d.daily_views || 0,
                    stockPrice: stock ? stock.close : null
                };
            }).reverse();

            renderTable(merged);
        }

        function renderTable(data) {
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = data.slice(start, end);

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            pageData.forEach((row, index) => {
                const prevRow = data[start + index + 1];
                
                const viewsChange = prevRow ? row.dailyViews - prevRow.dailyViews : 0;
                const viewsChangePct = prevRow && prevRow.dailyViews ? (viewsChange / prevRow.dailyViews * 100).toFixed(2) : 0;
                
                const stockChange = prevRow && prevRow.stockPrice && row.stockPrice ? 
                    row.stockPrice - prevRow.stockPrice : 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${formatNumber(row.dailyViews)}</td>
                    <td class="${viewsChange >= 0 ? 'positive' : 'negative'}">${viewsChange >= 0 ? '‚ñ≤' : '‚ñº'} ${formatNumber(Math.abs(viewsChange))}</td>
                    <td class="${viewsChangePct >= 0 ? 'positive' : 'negative'}">${viewsChangePct}%</td>
                    <td>${row.stockPrice ? '‚Çπ' + row.stockPrice.toFixed(2) : 'N/A'}</td>
                    <td class="${stockChange >= 0 ? 'positive' : 'negative'}">${row.stockPrice ? (stockChange >= 0 ? '‚ñ≤' : '‚ñº') + ' ‚Çπ' + Math.abs(stockChange).toFixed(2) : 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('paginationInfo').textContent = 
                `Showing ${start + 1}-${Math.min(end, data.length)} of ${data.length} records`;

            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = end >= data.length;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateDataTable();
            }
        }

        function nextPage() {
            currentPage++;
            updateDataTable();
        }

        // ============================================================
        // DATE HANDLING
        // ============================================================

        function updateDateRange() {
            const timeRange = document.getElementById('timeRange').value;
            const endDate = new Date();
            let startDate = new Date();

            if (timeRange === 'all') {
                startDate = new Date('2023-01-01');
            } else {
                startDate.setDate(endDate.getDate() - parseInt(timeRange));
            }

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

            loadDashboardData();
        }

        // ============================================================
        // UTILITIES
        // ============================================================

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================

        document.addEventListener('DOMContentLoaded', function() {
            updateDateRange();
        });
    </script>
</body>
</html>
