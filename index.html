<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tips Music Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .controls {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-item label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .control-item select,
        .control-item input {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 23px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 13px;
            color: #666;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-toggle {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chart-toggle:hover {
            border-color: #667eea;
        }

        .chart-toggle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .chart-wrapper.large {
            height: 500px;
        }

        .table-container {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .table-header {
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
        }

        tbody td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .footer {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            color: #666;
            font-size: 13px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéµ Tips Music Analytics Dashboard</h1>
            <p>Real-time YouTube performance metrics and stock price correlation analysis</p>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="timePeriod">Time Period</label>
                    <select id="timePeriod" onchange="updateDateRange()">
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="180">Last 6 Months</option>
                        <option value="365" selected>Last 1 Year</option>
                        <option value="all">All Time (2023-Present)</option>
                    </select>
                </div>
                <div class="control-item">
                    <label for="startDate">From Date</label>
                    <input type="date" id="startDate" onchange="customDateRange()">
                </div>
                <div class="control-item">
                    <label for="endDate">To Date</label>
                    <input type="date" id="endDate" onchange="customDateRange()">
                </div>
                <div class="control-item">
                    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Subscribers</h3>
                <div class="stat-value" id="totalSubs">--</div>
                <div class="stat-change" id="subsChange">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Total Views</h3>
                <div class="stat-value" id="totalViews">--</div>
                <div class="stat-change" id="viewsChange">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Daily Views (Latest)</h3>
                <div class="stat-value" id="dailyViews">--</div>
                <div class="stat-change" id="dailyViewsChange">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Stock Price (Latest)</h3>
                <div class="stat-value" id="stockPrice">--</div>
                <div class="stat-change" id="stockChange">Loading...</div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Daily Views Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">üìà Daily Views - Tips Music</h3>
                    <div class="chart-controls">
                        <button class="chart-toggle active" onclick="toggleViewsScale('linear')">Linear</button>
                        <button class="chart-toggle" onclick="toggleViewsScale('log')">Logarithmic</button>
                        <button class="chart-toggle" onclick="toggleViewsMA()">Show MA (7/30/45)</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="viewsChart"></canvas>
                </div>
            </div>

            <!-- Stock Price Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">üíπ Stock Price - NSE: TIPSMUSIC</h3>
                    <div class="chart-controls">
                        <button class="chart-toggle active" onclick="toggleStockScale('linear')">Linear</button>
                        <button class="chart-toggle" onclick="toggleStockScale('log')">Logarithmic</button>
                        <button class="chart-toggle" onclick="toggleStockMA()">Show MA (7/30/45)</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="stockChart"></canvas>
                </div>
            </div>

            <!-- Monthly Growth Chart -->
            <div class="chart-container full-width">
                <div class="chart-header">
                    <h3 class="chart-title">üìä Monthly Views Growth</h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Comparison Chart (Dual-Axis) -->
            <div class="chart-container full-width">
                <div class="chart-header">
                    <h3 class="chart-title">üîó Daily Views vs Stock Price (Dual-Axis)</h3>
                    <div class="chart-controls">
                        <button class="chart-toggle active" onclick="toggleComparisonMode('raw')">Raw Daily Views</button>
                        <button class="chart-toggle" onclick="toggleComparisonMode('ma30')">30-Day MA</button>
                        <button class="chart-toggle" onclick="toggleComparisonMode('ma45')">45-Day MA (Views)</button>
                        <button class="chart-toggle" onclick="toggleComparisonMode('ma45_both')">45-Day MA (Both)</button>
                    </div>
                </div>
                <div class="chart-wrapper large">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="chart-title">üìã Daily Channel Metrics</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Daily Views</th>
                        <th>Change</th>
                        <th>% Change</th>
                        <th>Stock Price (‚Çπ)</th>
                        <th>Stock Change</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center;">Loading data...</td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination">
                <button onclick="previousPage()" id="prevBtn">‚Üê Previous</button>
                <span id="pageInfo">Showing 0-0 of 0 records</span>
                <button onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p><strong>Last updated:</strong> <span id="lastUpdate">--</span></p>
            <p>| Data source: Supabase PostgreSQL | Stock: NSE TIPSMUSIC</p>
        </div>
    </div>

    <script>
        // ============================================================================
        // GLOBAL VARIABLES
        // ============================================================================
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        let dashboardData = {
            tipsDaily: [],
            tipsMonthly: [],
            stockPrices: []
        };

        let viewsChart, stockChart, monthlyChart, comparisonChart;
        let viewsScale = 'linear';
        let stockScale = 'linear';
        let showViewsMA = false;
        let showStockMA = false;
        let comparisonMode = 'raw';
        let currentPage = 1;
        const rowsPerPage = 20;

        // ============================================================================
        // DATA FETCHING
        // ============================================================================
        async function fetchSupabase(endpoint) {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });
            return response.json();
        }

        async function loadData() {
            try {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                // Fetch Tips daily data
                const dailyData = await fetchSupabase(`daily_label_totals?label=eq.Tips&date=gte.${startDate}&date=lte.${endDate}&order=date.asc`);
                
                // Fetch Tips monthly data
                const monthlyData = await fetchSupabase(`monthly_label_totals?label=eq.Tips&month=gte.${startDate.substring(0, 7)}&month=lte.${endDate.substring(0, 7)}&order=month.asc`);
                
                // Fetch stock prices
                const stockData = await fetchSupabase(`stock_prices?symbol=eq.TIPSMUSIC&date=gte.${startDate}&date=lte.${endDate}&order=date.asc`);

                dashboardData.tipsDaily = dailyData;
                dashboardData.tipsMonthly = monthlyData;
                dashboardData.stockPrices = stockData;

                updateStats();
                updateCharts();
                updateTable();
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();

            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Please check console for details.');
            }
        }

        // ============================================================================
        // STATS UPDATE
        // ============================================================================
        function updateStats() {
            const { tipsDaily, stockPrices } = dashboardData;

            if (tipsDaily.length > 0) {
                const latest = tipsDaily[tipsDaily.length - 1];
                const previous = tipsDaily[tipsDaily.length - 2];

                document.getElementById('totalSubs').textContent = latest.total_subscribers.toLocaleString();
                document.getElementById('totalViews').textContent = latest.total_views.toLocaleString();
                document.getElementById('dailyViews').textContent = (latest.daily_views || 0).toLocaleString();

                if (previous) {
                    const subsChange = latest.total_subscribers - previous.total_subscribers;
                    const viewsChange = latest.total_views - previous.total_views;
                    const dailyChange = (latest.daily_views || 0) - (previous.daily_views || 0);

                    document.getElementById('subsChange').textContent = `${subsChange >= 0 ? '+' : ''}${subsChange.toLocaleString()} from previous day`;
                    document.getElementById('subsChange').className = subsChange >= 0 ? 'stat-change positive' : 'stat-change negative';

                    document.getElementById('viewsChange').textContent = `${viewsChange >= 0 ? '+' : ''}${viewsChange.toLocaleString()} from previous day`;
                    document.getElementById('viewsChange').className = viewsChange >= 0 ? 'stat-change positive' : 'stat-change negative';

                    document.getElementById('dailyViewsChange').textContent = `${dailyChange >= 0 ? '+' : ''}${dailyChange.toLocaleString()} from previous day`;
                    document.getElementById('dailyViewsChange').className = dailyChange >= 0 ? 'stat-change positive' : 'stat-change negative';
                }
            }

            if (stockPrices.length > 0) {
                const latestStock = stockPrices[stockPrices.length - 1];
                const previousStock = stockPrices[stockPrices.length - 2];

                document.getElementById('stockPrice').textContent = `‚Çπ${latestStock.close.toFixed(2)}`;

                if (previousStock) {
                    const stockChange = latestStock.close - previousStock.close;
                    const stockChangePct = ((stockChange / previousStock.close) * 100).toFixed(2);

                    document.getElementById('stockChange').textContent = `${stockChange >= 0 ? '+' : ''}‚Çπ${stockChange.toFixed(2)} (${stockChangePct}%)`;
                    document.getElementById('stockChange').className = stockChange >= 0 ? 'stat-change positive' : 'stat-change negative';
                }
            }
        }

        // ============================================================================
        // CHART UTILITIES
        // ============================================================================
        function calculateSMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => (a || 0) + (b || 0), 0);
                    result.push(sum / period);
                }
            }
            return result;
        }

        // ============================================================================
        // CHARTS UPDATE
        // ============================================================================
        function updateCharts() {
            updateViewsChart();
            updateStockChart();
            updateMonthlyChart();
            updateComparisonChart();
        }

        function updateViewsChart() {
            const { tipsDaily } = dashboardData;
            
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            const filteredData = tipsDaily.filter(d => {
                const date = new Date(d.date);
                return date >= startDate && date <= endDate;
            });

            const dates = filteredData.map(d => d.date);
            const dailyViews = filteredData.map(d => d.daily_views || 0);

            const datasets = [{
                label: 'Daily Views',
                data: dailyViews,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.3,
                borderWidth: 2.5,
                pointRadius: 0,
                pointHoverRadius: 5
            }];

            if (showViewsMA) {
                datasets.push({
                    label: '7-Day MA',
                    data: calculateSMA(dailyViews, 7),
                    borderColor: 'rgb(255, 159, 64)',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [5, 5]
                });
                datasets.push({
                    label: '30-Day MA',
                    data: calculateSMA(dailyViews, 30),
                    borderColor: 'rgb(153, 102, 255)',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [5, 5]
                });
                datasets.push({
                    label: '45-Day MA',
                    data: calculateSMA(dailyViews, 45),
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [5, 5]
                });
            }

            if (viewsChart) {
                viewsChart.destroy();
            }

            const ctx = document.getElementById('viewsChart');
            viewsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: viewsScale,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 15
                            }
                        }
                    }
                }
            });
        }

        function updateStockChart() {
            const { stockPrices } = dashboardData;
            
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            const filteredData = stockPrices.filter(d => {
                const date = new Date(d.date);
                return date >= startDate && date <= endDate && d.close > 0;
            });

            const dates = filteredData.map(d => d.date);
            const closePrices = filteredData.map(d => d.close);

            const datasets = [{
                label: 'Stock Price (‚Çπ)',
                data: closePrices,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.3,
                borderWidth: 2.5,
                pointRadius: 0,
                pointHoverRadius: 5
            }];

            if (showStockMA) {
                datasets.push({
                    label: '7-Day MA',
                    data: calculateSMA(closePrices, 7),
                    borderColor: 'rgb(255, 159, 64)',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [5, 5]
                });
                datasets.push({
                    label: '30-Day MA',
                    data: calculateSMA(closePrices, 30),
                    borderColor: 'rgb(153, 102, 255)',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [5, 5]
                });
                datasets.push({
                    label: '45-Day MA',
                    data: calculateSMA(closePrices, 45),
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 2,
                    pointRadius: 0,
                    borderDash: [5, 5]
                });
            }

            if (stockChart) {
                stockChart.destroy();
            }

            const ctx = document.getElementById('stockChart');
            stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: stockScale,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 15
                            }
                        }
                    }
                }
            });
        }

        function updateMonthlyChart() {
            const { tipsMonthly } = dashboardData;

            const months = tipsMonthly.map(d => d.month);
            const viewsGrowth = tipsMonthly.map(d => d.mom_views_growth_pct || 0);
            const subsGrowth = tipsMonthly.map(d => d.mom_subs_growth_pct || 0);

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            const ctx = document.getElementById('monthlyChart');
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Views Growth %',
                            data: viewsGrowth,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 1
                        },
                        {
                            label: 'Subs Growth %',
                            data: subsGrowth,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgb(153, 102, 255)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateComparisonChart() {
            const { tipsDaily, stockPrices } = dashboardData;
            
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            const filteredDaily = tipsDaily.filter(d => {
                const date = new Date(d.date);
                return date >= startDate && date <= endDate;
            });

            const filteredStock = stockPrices.filter(s => {
                const date = new Date(s.date);
                return date >= startDate && date <= endDate && s.close > 0;
            });

            const dates = filteredDaily.map(d => d.date);
            const dailyViews = filteredDaily.map(d => d.daily_views || 0);

            let viewsData = dailyViews;
            let viewsLabel = 'Daily Views';

            // Calculate moving averages for views
            if (comparisonMode === 'ma30') {
                viewsData = calculateSMA(dailyViews, 30);
                viewsLabel = 'Daily Views (30-Day MA)';
            } else if (comparisonMode === 'ma45' || comparisonMode === 'ma45_both') {
                viewsData = calculateSMA(dailyViews, 45);
                viewsLabel = 'Daily Views (45-Day MA)';
            }

            // Map stock prices to match dates
            const stockData = dates.map(date => {
                const stockEntry = filteredStock.find(s => s.date === date);
                return stockEntry ? stockEntry.close : null;
            });

            // Calculate stock price moving average if needed
            let stockDataFinal = stockData;
            let stockLabel = 'Stock Price (‚Çπ)';
            
            if (comparisonMode === 'ma45_both') {
                stockDataFinal = calculateSMA(stockData, 45);
                stockLabel = 'Stock Price (‚Çπ) - 45-Day MA';
            }

            if (comparisonChart) {
                comparisonChart.destroy();
            }

            const ctx = document.getElementById('comparisonChart');
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: viewsLabel,
                            data: viewsData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3,
                            borderWidth: 2.5,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: stockLabel,
                            data: stockDataFinal,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.3,
                            borderWidth: 2.5,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.datasetIndex === 0) {
                                            label += context.parsed.y.toLocaleString();
                                        } else {
                                            label += '‚Çπ' + context.parsed.y.toFixed(2);
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            ticks: {
                                maxTicksLimit: 15
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: viewsLabel
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: stockLabel
                            },
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ' + value.toFixed(2);
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            }
                        }
                    }
                }
            });
        }

        // ============================================================================
        // TABLE UPDATE
        // ============================================================================
        function updateTable() {
            const { tipsDaily, stockPrices } = dashboardData;
            
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            const filteredDaily = tipsDaily.filter(d => {
                const date = new Date(d.date);
                return date >= startDate && date <= endDate;
            }).reverse();

            const totalRows = filteredDaily.length;
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = Math.min(startIdx + rowsPerPage, totalRows);

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            for (let i = startIdx; i < endIdx; i++) {
                const row = filteredDaily[i];
                const previousRow = filteredDaily[i + 1];
                const stockEntry = stockPrices.find(s => s.date === row.date);
                const previousStock = stockPrices.find(s => s.date === (previousRow?.date));

                const dailyViews = row.daily_views || 0;
                const viewsChange = previousRow ? dailyViews - (previousRow.daily_views || 0) : 0;
                const viewsChangePct = previousRow && previousRow.daily_views ? ((viewsChange / previousRow.daily_views) * 100).toFixed(2) : '0.00';

                const stockPrice = stockEntry ? stockEntry.close : null;
                const stockChange = (stockEntry && previousStock) ? (stockEntry.close - previousStock.close).toFixed(2) : '--';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${dailyViews.toLocaleString()}</td>
                    <td class="${viewsChange >= 0 ? 'positive' : 'negative'}">${viewsChange >= 0 ? '+' : ''}${viewsChange.toLocaleString()}</td>
                    <td class="${viewsChangePct >= 0 ? 'positive' : 'negative'}">${viewsChangePct}%</td>
                    <td>${stockPrice ? '‚Çπ' + stockPrice.toFixed(2) : '--'}</td>
                    <td class="${stockChange >= 0 ? 'positive' : 'negative'}">${stockChange !== '--' ? (stockChange >= 0 ? '+‚Çπ' : '‚Çπ') + stockChange : '--'}</td>
                `;
                tbody.appendChild(tr);
            }

            document.getElementById('pageInfo').textContent = `Showing ${startIdx + 1}-${endIdx} of ${totalRows} records`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = endIdx >= totalRows;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }

        function nextPage() {
            const totalRows = dashboardData.tipsDaily.filter(d => {
                const date = new Date(d.date);
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                return date >= startDate && date <= endDate;
            }).length;

            if (currentPage * rowsPerPage < totalRows) {
                currentPage++;
                updateTable();
            }
        }

        // ============================================================================
        // CONTROL FUNCTIONS
        // ============================================================================
        function updateDateRange() {
            const period = document.getElementById('timePeriod').value;
            const endDate = new Date();
            let startDate = new Date();

            if (period === 'all') {
                startDate = new Date('2023-01-01');
            } else {
                startDate.setDate(endDate.getDate() - parseInt(period));
            }

            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            
            loadData();
        }

        function customDateRange() {
            document.getElementById('timePeriod').value = '';
            loadData();
        }

        function toggleViewsScale(scale) {
            viewsScale = scale;
            updateViewsChart();

            const container = document.getElementById('viewsChart').closest('.chart-container');
            container.querySelectorAll('.chart-toggle').forEach(btn => {
                btn.classList.remove('active');
                if ((scale === 'linear' && btn.textContent === 'Linear') ||
                    (scale === 'log' && btn.textContent === 'Logarithmic')) {
                    btn.classList.add('active');
                }
            });
        }

        function toggleStockScale(scale) {
            stockScale = scale;
            updateStockChart();

            const container = document.getElementById('stockChart').closest('.chart-container');
            container.querySelectorAll('.chart-toggle').forEach(btn => {
                btn.classList.remove('active');
                if ((scale === 'linear' && btn.textContent === 'Linear') ||
                    (scale === 'log' && btn.textContent === 'Logarithmic')) {
                    btn.classList.add('active');
                }
            });
        }

        function toggleViewsMA() {
            showViewsMA = !showViewsMA;
            updateViewsChart();

            const container = document.getElementById('viewsChart').closest('.chart-container');
            const btn = Array.from(container.querySelectorAll('.chart-toggle')).find(b => b.textContent.includes('Show MA'));
            if (btn) {
                btn.classList.toggle('active');
            }
        }

        function toggleStockMA() {
            showStockMA = !showStockMA;
            updateStockChart();

            const container = document.getElementById('stockChart').closest('.chart-container');
            const btn = Array.from(container.querySelectorAll('.chart-toggle')).find(b => b.textContent.includes('Show MA'));
            if (btn) {
                btn.classList.toggle('active');
            }
        }

        function toggleComparisonMode(mode) {
            comparisonMode = mode;
            updateComparisonChart();

            const container = document.getElementById('comparisonChart').closest('.chart-container');
            container.querySelectorAll('.chart-toggle').forEach(btn => {
                btn.classList.remove('active');
                if ((mode === 'raw' && btn.textContent.includes('Raw')) ||
                    (mode === 'ma30' && btn.textContent.includes('30-Day')) ||
                    (mode === 'ma45' && btn.textContent.includes('45-Day (Views)')) ||
                    (mode === 'ma45_both' && btn.textContent.includes('45-Day MA (Both)'))) {
                    btn.classList.add('active');
                }
            });
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        document.getElementById('endDate').valueAsDate = new Date();
        updateDateRange();
        
        window.addEventListener('load', () => {
            loadData();
        });
    </script>
</body>
</html>
