<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tips Music Analytics Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        select, input, button {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            padding: 10px 25px;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .stat-change {
            font-size: 0.85em;
            margin-top: 5px;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-title {
            font-size: 1.5em;
            color: #495057;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-group {
            display: flex;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
        }

        .toggle-btn {
            padding: 8px 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .toggle-btn:hover {
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-size: 0.9em;
            color: #495057;
            font-weight: 500;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pagination button {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .positive {
            color: #28a745;
            font-weight: 600;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
            color: #6c757d;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Tips Music Analytics Dashboard</h1>
            <p class="subtitle">YouTube Performance & Stock Price Correlation Analysis</p>
        </header>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label>‚è±Ô∏è Time Period</label>
                <select id="timePeriod" onchange="applyTimePeriod()">
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                    <option value="365" selected>Last 1 Year</option>
                    <option value="all">All Time (2023-Present)</option>
                </select>
            </div>
            <div class="control-group">
                <label>üìÖ From Date</label>
                <input type="date" id="fromDate">
            </div>
            <div class="control-group">
                <label>üìÖ To Date</label>
                <input type="date" id="toDate">
            </div>
            <button onclick="loadData()" style="margin-top: 20px;">üîÑ Refresh Data</button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Subscribers</div>
                <div class="stat-value" id="totalSubs">--</div>
                <div class="stat-change" id="subsChange">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Views</div>
                <div class="stat-value" id="totalViews">--</div>
                <div class="stat-change" id="viewsChange">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Daily Views (Latest)</div>
                <div class="stat-value" id="dailyViews">--</div>
                <div class="stat-change" id="dailyChange">Loading...</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Stock Price (Latest)</div>
                <div class="stat-value" id="stockPrice">--</div>
                <div class="stat-change" id="stockChange">Loading...</div>
            </div>
        </div>

        <!-- Chart 1: Daily Views -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">üìà Daily Views - Tips Music</h2>
                <div class="chart-controls">
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="setViewsScale('linear')">Linear</button>
                        <button class="toggle-btn" onclick="setViewsScale('log')">Logarithmic</button>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showViewsMA" onchange="updateViewsChart()">
                        <label for="showViewsMA">Show MA (7/30/45)</label>
                    </div>
                </div>
            </div>
            <div id="viewsChart"></div>
        </div>

        <!-- Chart 2: Stock Price -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">üíπ Stock Price - NSE: TIPSMUSIC</h2>
                <div class="chart-controls">
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="setStockScale('linear')">Linear</button>
                        <button class="toggle-btn" onclick="setStockScale('log')">Logarithmic</button>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showStockMA" onchange="updateStockChart()">
                        <label for="showStockMA">Show MA (7/30/45)</label>
                    </div>
                </div>
            </div>
            <div id="stockChart"></div>
        </div>

        <!-- Chart 3: Monthly Views Growth -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">üìä Monthly Views Growth</h2>
            </div>
            <div id="monthlyChart"></div>
        </div>

        <!-- Chart 4: Dual Axis Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">üîó Daily Views vs Stock Price (Dual-Axis)</h2>
                <div class="chart-controls">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showDualRaw" checked onchange="updateDualAxisChart()">
                        <label for="showDualRaw">Raw Daily Views</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showDual30MA" onchange="updateDualAxisChart()">
                        <label for="showDual30MA">30-Day MA</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showDual45MA" onchange="updateDualAxisChart()">
                        <label for="showDual45MA">45-Day MA</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="showDualStock45MA" onchange="updateDualAxisChart()">
                        <label for="showDualStock45MA">Stock 45-Day MA</label>
                    </div>
                </div>
            </div>
            <div id="dualAxisChart"></div>
        </div>

        <!-- Data Table -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">üìã Daily Channel Metrics</h2>
            </div>
            <div style="overflow-x: auto;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Daily Views</th>
                            <th>Change</th>
                            <th>% Change</th>
                            <th>Stock Price (‚Çπ)</th>
                            <th>Stock Change</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="6" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button onclick="previousPage()">‚Üê Previous</button>
                <span id="pageInfo">Showing 0-0 of 0 records</span>
                <button onclick="nextPage()">Next ‚Üí</button>
            </div>
        </div>

        <footer>
            <p>Last updated: <span id="lastUpdate">--</span> | Data source: Supabase PostgreSQL | Stock: NSE TIPSMUSIC</p>
        </footer>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        // Global state
        let rawData = [];
        let filteredData = [];
        let currentPage = 1;
        const rowsPerPage = 50;
        let viewsChartScale = 'linear';
        let stockChartScale = 'linear';

        // ============================================================
        // DATA FETCHING
        // ============================================================
        async function fetchData(query) {
            const url = `${SUPABASE_URL}/rest/v1/${query}`;
            const response = await fetch(url, {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            });
            return await response.json();
        }

        async function loadData() {
            try {
                // Fetch unified analysis data
                const data = await fetchData('unified_analysis?select=*&order=date.desc&limit=2000');
                
                rawData = data.filter(d => d.stock_price !== null);
                applyTimePeriod();
                
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading data. Please check console.');
            }
        }

        function applyTimePeriod() {
            const period = document.getElementById('timePeriod').value;
            const now = new Date();
            let cutoffDate;

            if (period === 'all') {
                filteredData = [...rawData];
            } else {
                const days = parseInt(period);
                cutoffDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
                filteredData = rawData.filter(d => new Date(d.date) >= cutoffDate);
            }

            // Apply custom date filters if set
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;

            if (fromDate) {
                filteredData = filteredData.filter(d => new Date(d.date) >= new Date(fromDate));
            }
            if (toDate) {
                filteredData = filteredData.filter(d => new Date(d.date) <= new Date(toDate));
            }

            updateDashboard();
        }

        // ============================================================
        // STATISTICS CALCULATION
        // ============================================================
        function calculateMovingAverage(data, window) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < window - 1) {
                    result.push(null);
                } else {
                    const sum = data.slice(i - window + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / window);
                }
            }
            return result;
        }

        function updateStats() {
            if (filteredData.length === 0) return;

            const latest = filteredData[0];
            const previous = filteredData[1] || latest;

            // Total Subscribers
            document.getElementById('totalSubs').textContent = latest.tips_subscribers?.toLocaleString() || '--';
            const subsChange = ((latest.tips_subscribers - previous.tips_subscribers) / previous.tips_subscribers * 100).toFixed(2);
            document.getElementById('subsChange').innerHTML = `${subsChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(subsChange)}% vs previous`;

            // Total Views
            document.getElementById('totalViews').textContent = latest.tips_views?.toLocaleString() || '--';
            const viewsChange = ((latest.tips_views - previous.tips_views) / previous.tips_views * 100).toFixed(2);
            document.getElementById('viewsChange').innerHTML = `${viewsChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(viewsChange)}% vs previous`;

            // Daily Views
            document.getElementById('dailyViews').textContent = latest.daily_views_change?.toLocaleString() || '--';
            const dailyChange = latest.daily_views_change - (previous.daily_views_change || 0);
            document.getElementById('dailyChange').innerHTML = `${dailyChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(dailyChange).toLocaleString()} views`;

            // Stock Price
            document.getElementById('stockPrice').textContent = `‚Çπ${latest.stock_price?.toFixed(2) || '--'}`;
            const stockChange = ((latest.stock_price - previous.stock_price) / previous.stock_price * 100).toFixed(2);
            document.getElementById('stockChange').innerHTML = `${stockChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stockChange)}% (‚Çπ${Math.abs(latest.stock_price - previous.stock_price).toFixed(2)})`;
        }

        // ============================================================
        // CHART UPDATES
        // ============================================================
        function updateViewsChart() {
            const dates = filteredData.map(d => d.date).reverse();
            const views = filteredData.map(d => d.daily_views_change || 0).reverse();
            
            const traces = [{
                x: dates,
                y: views,
                type: 'scatter',
                mode: 'lines',
                name: 'Daily Views',
                line: { color: '#667eea', width: 2 }
            }];

            if (document.getElementById('showViewsMA').checked) {
                const ma7 = calculateMovingAverage(views, 7);
                const ma30 = calculateMovingAverage(views, 30);
                const ma45 = calculateMovingAverage(views, 45);

                traces.push({
                    x: dates,
                    y: ma7,
                    type: 'scatter',
                    mode: 'lines',
                    name: '7-Day MA',
                    line: { color: '#ffa726', width: 2, dash: 'dot' }
                });

                traces.push({
                    x: dates,
                    y: ma30,
                    type: 'scatter',
                    mode: 'lines',
                    name: '30-Day MA',
                    line: { color: '#26a69a', width: 2, dash: 'dash' }
                });

                traces.push({
                    x: dates,
                    y: ma45,
                    type: 'scatter',
                    mode: 'lines',
                    name: '45-Day MA',
                    line: { color: '#ef5350', width: 2, dash: 'dashdot' }
                });
            }

            const layout = {
                title: '',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Daily Views', type: viewsChartScale },
                hovermode: 'x unified',
                showlegend: true,
                height: 450
            };

            Plotly.newPlot('viewsChart', traces, layout, {responsive: true});
        }

        function updateStockChart() {
            const dates = filteredData.map(d => d.date).reverse();
            const prices = filteredData.map(d => d.stock_price).reverse();
            
            const traces = [{
                x: dates,
                y: prices,
                type: 'scatter',
                mode: 'lines',
                name: 'Stock Price',
                line: { color: '#764ba2', width: 2 }
            }];

            if (document.getElementById('showStockMA').checked) {
                const ma7 = calculateMovingAverage(prices, 7);
                const ma30 = calculateMovingAverage(prices, 30);
                const ma45 = calculateMovingAverage(prices, 45);

                traces.push({
                    x: dates,
                    y: ma7,
                    type: 'scatter',
                    mode: 'lines',
                    name: '7-Day MA',
                    line: { color: '#ffa726', width: 2, dash: 'dot' }
                });

                traces.push({
                    x: dates,
                    y: ma30,
                    type: 'scatter',
                    mode: 'lines',
                    name: '30-Day MA',
                    line: { color: '#26a69a', width: 2, dash: 'dash' }
                });

                traces.push({
                    x: dates,
                    y: ma45,
                    type: 'scatter',
                    mode: 'lines',
                    name: '45-Day MA',
                    line: { color: '#ef5350', width: 2, dash: 'dashdot' }
                });
            }

            const layout = {
                title: '',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Stock Price (‚Çπ)', type: stockChartScale },
                hovermode: 'x unified',
                showlegend: true,
                height: 450
            };

            Plotly.newPlot('stockChart', traces, layout, {responsive: true});
        }

        function updateMonthlyChart() {
            // Aggregate by month
            const monthlyData = {};
            filteredData.forEach(d => {
                const month = d.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = {
                        views: 0,
                        count: 0
                    };
                }
                monthlyData[month].views += d.daily_views_change || 0;
                monthlyData[month].count++;
            });

            const months = Object.keys(monthlyData).sort();
            const totalViews = months.map(m => monthlyData[m].views);
            const avgDailyViews = months.map(m => monthlyData[m].views / monthlyData[m].count);

            const traces = [
                {
                    x: months,
                    y: totalViews,
                    type: 'bar',
                    name: 'Total Monthly Views',
                    marker: { color: '#667eea' }
                },
                {
                    x: months,
                    y: avgDailyViews,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Avg Daily Views',
                    yaxis: 'y2',
                    line: { color: '#764ba2', width: 3 },
                    marker: { size: 8 }
                }
            ];

            const layout = {
                title: '',
                xaxis: { title: 'Month' },
                yaxis: { title: 'Total Monthly Views' },
                yaxis2: {
                    title: 'Avg Daily Views',
                    overlaying: 'y',
                    side: 'right'
                },
                hovermode: 'x unified',
                showlegend: true,
                height: 450
            };

            Plotly.newPlot('monthlyChart', traces, layout, {responsive: true});
        }

        function updateDualAxisChart() {
            const dates = filteredData.map(d => d.date).reverse();
            const views = filteredData.map(d => d.daily_views_change || 0).reverse();
            const prices = filteredData.map(d => d.stock_price).reverse();
            
            const traces = [];

            // Raw Daily Views
            if (document.getElementById('showDualRaw').checked) {
                traces.push({
                    x: dates,
                    y: views,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Daily Views',
                    line: { color: '#667eea', width: 2 },
                    yaxis: 'y'
                });
            }

            // 30-Day MA for Views
            if (document.getElementById('showDual30MA').checked) {
                const ma30 = calculateMovingAverage(views, 30);
                traces.push({
                    x: dates,
                    y: ma30,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Views 30-Day MA',
                    line: { color: '#26a69a', width: 2, dash: 'dash' },
                    yaxis: 'y'
                });
            }

            // 45-Day MA for Views
            if (document.getElementById('showDual45MA').checked) {
                const ma45 = calculateMovingAverage(views, 45);
                traces.push({
                    x: dates,
                    y: ma45,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Views 45-Day MA',
                    line: { color: '#ef5350', width: 2, dash: 'dashdot' },
                    yaxis: 'y'
                });
            }

            // Stock Price (Always shown)
            traces.push({
                x: dates,
                y: prices,
                type: 'scatter',
                mode: 'lines',
                name: 'Stock Price',
                line: { color: '#764ba2', width: 2 },
                yaxis: 'y2'
            });

            // Stock 45-Day MA
            if (document.getElementById('showDualStock45MA').checked) {
                const stockMA45 = calculateMovingAverage(prices, 45);
                traces.push({
                    x: dates,
                    y: stockMA45,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Stock 45-Day MA',
                    line: { color: '#ff6f00', width: 3, dash: 'dot' },
                    yaxis: 'y2'
                });
            }

            const layout = {
                title: '',
                xaxis: { title: 'Date' },
                yaxis: {
                    title: 'Daily Views',
                    titlefont: { color: '#667eea' },
                    tickfont: { color: '#667eea' }
                },
                yaxis2: {
                    title: 'Stock Price (‚Çπ)',
                    titlefont: { color: '#764ba2' },
                    tickfont: { color: '#764ba2' },
                    overlaying: 'y',
                    side: 'right'
                },
                hovermode: 'x unified',
                showlegend: true,
                height: 500
            };

            Plotly.newPlot('dualAxisChart', traces, layout, {responsive: true});
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            const startIdx = (currentPage - 1) * rowsPerPage;
            const endIdx = startIdx + rowsPerPage;
            const pageData = filteredData.slice(startIdx, endIdx);

            tbody.innerHTML = '';

            pageData.forEach((row, idx) => {
                const prevRow = filteredData[startIdx + idx + 1];
                const viewsChange = prevRow ? row.daily_views_change - prevRow.daily_views_change : 0;
                const viewsChangePct = prevRow && prevRow.daily_views_change ? (viewsChange / prevRow.daily_views_change * 100).toFixed(2) : 0;
                const stockChange = prevRow ? row.stock_price - prevRow.stock_price : 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${(row.daily_views_change || 0).toLocaleString()}</td>
                    <td class="${viewsChange >= 0 ? 'positive' : 'negative'}">${viewsChange >= 0 ? '+' : ''}${viewsChange.toLocaleString()}</td>
                    <td class="${viewsChangePct >= 0 ? 'positive' : 'negative'}">${viewsChangePct >= 0 ? '+' : ''}${viewsChangePct}%</td>
                    <td>‚Çπ${row.stock_price?.toFixed(2) || '--'}</td>
                    <td class="${stockChange >= 0 ? 'positive' : 'negative'}">${stockChange >= 0 ? '+' : ''}‚Çπ${stockChange.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pageInfo').textContent = 
                `Showing ${startIdx + 1}-${Math.min(endIdx, filteredData.length)} of ${filteredData.length} records`;
        }

        // ============================================================
        // UI CONTROLS
        // ============================================================
        function setViewsScale(scale) {
            viewsChartScale = scale;
            document.querySelectorAll('#viewsChart').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateViewsChart();
        }

        function setStockScale(scale) {
            stockChartScale = scale;
            document.querySelectorAll('#stockChart').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateStockChart();
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }

        function nextPage() {
            const maxPage = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < maxPage) {
                currentPage++;
                updateTable();
            }
        }

        function updateDashboard() {
            updateStats();
            updateViewsChart();
            updateStockChart();
            updateMonthlyChart();
            updateDualAxisChart();
            updateTable();
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================
        window.onload = function() {
            // Set default dates
            const toDate = new Date();
            const fromDate = new Date(toDate.getTime() - 365 * 24 * 60 * 60 * 1000);
            
            document.getElementById('toDate').valueAsDate = toDate;
            document.getElementById('fromDate').valueAsDate = fromDate;

            loadData();
        };
    </script>
</body>
</html>
