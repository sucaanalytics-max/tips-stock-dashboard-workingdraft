<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tips Music Analytics Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            min-width: 100px;
        }

        select, input[type="date"], button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            padding: 12px 25px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 25px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            border-left: 4px solid #667eea;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 0.85em;
            color: #28a745;
        }

        .stat-card .change.negative {
            color: #dc3545;
        }

        .charts-section {
            padding: 25px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-header h2 {
            color: #1e3c72;
            font-size: 1.5em;
        }

        .chart-options {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle-group {
            display: flex;
            background: #f0f0f0;
            border-radius: 8px;
            padding: 3px;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s;
            color: #666;
        }

        .toggle-btn.active {
            background: white;
            color: #667eea;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f0f0f0;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            font-size: 13px;
            color: #666;
            user-select: none;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .pagination button {
            padding: 8px 16px;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .footer {
            background: #1e3c72;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
        }

        @media (max-width: 768px) {
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-header {
                flex-direction: column;
                align-items: stretch;
            }

            .chart-options {
                flex-direction: column;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Tips Music Analytics Dashboard</h1>
            <p>YouTube Performance vs Stock Price Analysis</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>‚è±Ô∏è Time Period</label>
                <select id="timePeriod">
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="180">Last 6 Months</option>
                    <option value="365" selected>Last 1 Year</option>
                    <option value="all">All Time (2023-Present)</option>
                </select>
            </div>
            <div class="control-group">
                <label>üìÖ From Date</label>
                <input type="date" id="fromDate">
                <label>To Date</label>
                <input type="date" id="toDate">
                <button onclick="refreshData()">üîÑ Refresh Data</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Subscribers</h3>
                <div class="value" id="totalSubscribers">--</div>
                <div class="change" id="subsChange">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Total Views</h3>
                <div class="value" id="totalViews">--</div>
                <div class="change" id="viewsChange">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Daily Views (Latest)</h3>
                <div class="value" id="dailyViews">--</div>
                <div class="change" id="dailyViewsChange">Loading...</div>
            </div>
            <div class="stat-card">
                <h3>Stock Price (Latest)</h3>
                <div class="value" id="stockPrice">--</div>
                <div class="change" id="stockChange">Loading...</div>
            </div>
        </div>

        <div class="charts-section">
            <!-- Daily Views Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>üìà Daily Views - Tips Music</h2>
                    <div class="chart-options">
                        <div class="toggle-group">
                            <button class="toggle-btn active" onclick="toggleViewsScale('linear')">Linear</button>
                            <button class="toggle-btn" onclick="toggleViewsScale('log')">Logarithmic</button>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="showViewsMA" onchange="updateViewsChart()">
                            <label for="showViewsMA">Show MA (7/30/45)</label>
                        </div>
                    </div>
                </div>
                <div id="dailyViewsChart"></div>
            </div>

            <!-- Stock Price Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>üíπ Stock Price - NSE: TIPSMUSIC</h2>
                    <div class="chart-options">
                        <div class="toggle-group">
                            <button class="toggle-btn active" onclick="toggleStockScale('linear')">Linear</button>
                            <button class="toggle-btn" onclick="toggleStockScale('log')">Logarithmic</button>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="showStockMA" onchange="updateStockChart()">
                            <label for="showStockMA">Show MA (7/30/45)</label>
                        </div>
                    </div>
                </div>
                <div id="stockPriceChart"></div>
            </div>

            <!-- Monthly Growth Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>üìä Monthly Views Growth</h2>
                </div>
                <div id="monthlyGrowthChart"></div>
            </div>

            <!-- Dual Axis Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2>üîó Daily Views vs Stock Price (Dual-Axis)</h2>
                    <div class="chart-options">
                        <div class="toggle-group">
                            <button class="toggle-btn active" onclick="toggleDualAxisMode('raw')">Raw Daily Views</button>
                            <button class="toggle-btn" onclick="toggleDualAxisMode('ma30')">30-Day MA</button>
                            <button class="toggle-btn" onclick="toggleDualAxisMode('ma45')">45-Day MA</button>
                            <button class="toggle-btn" onclick="toggleDualAxisMode('ma45_stock')">45-DMA (Views + Stock)</button>
                        </div>
                    </div>
                </div>
                <div id="dualAxisChart"></div>
            </div>

            <!-- Data Table -->
            <div class="table-container">
                <div class="chart-header">
                    <h2>üìã Daily Channel Metrics</h2>
                </div>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Daily Views</th>
                            <th>Change</th>
                            <th>% Change</th>
                            <th>Stock Price (‚Çπ)</th>
                            <th>Stock Change</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
                <div class="pagination">
                    <button onclick="previousPage()">‚Üê Previous</button>
                    <span id="pageInfo">Showing 0-0 of 0 records</span>
                    <button onclick="nextPage()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Last updated: <span id="lastUpdated">--</span></p>
            <p>üíæ Data source: Supabase PostgreSQL | üìà Stock: NSE TIPSMUSIC</p>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://bfafqccvzboyfjewzvhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJmYWZxY2N2emJveWZqZXd6dmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2OTM4NzUsImV4cCI6MjA4MzI2OTg3NX0.OoyXHxHxAvSiE28NG3fz-S5QXcKz6OwspLrb9mSGH2Q';

        // Global state
        let allData = [];
        let currentPage = 1;
        const rowsPerPage = 20;
        let viewsScaleType = 'linear';
        let stockScaleType = 'linear';
        let dualAxisMode = 'raw';

        // Utility Functions
        function formatNumber(num) {
            if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
            return num.toFixed(0);
        }

        function formatCurrency(num) {
            return '‚Çπ' + num.toFixed(2);
        }

        function calculateMA(data, window) {
            const ma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < window - 1) {
                    ma.push(null);
                } else {
                    const sum = data.slice(i - window + 1, i + 1).reduce((a, b) => a + (b || 0), 0);
                    ma.push(sum / window);
                }
            }
            return ma;
        }

        // Data Fetching
        async function fetchData() {
            try {
                const timePeriod = document.getElementById('timePeriod').value;
                let dateFilter = '';

                if (timePeriod !== 'all') {
                    const days = parseInt(timePeriod);
                    const fromDate = new Date();
                    fromDate.setDate(fromDate.getDate() - days);
                    dateFilter = `&date=gte.${fromDate.toISOString().split('T')[0]}`;
                }

                const fromDateInput = document.getElementById('fromDate').value;
                const toDateInput = document.getElementById('toDate').value;
                
                if (fromDateInput) {
                    dateFilter = `&date=gte.${fromDateInput}`;
                }
                if (toDateInput) {
                    dateFilter += `&date=lte.${toDateInput}`;
                }

                const url = `${SUPABASE_URL}/rest/v1/unified_analysis?select=*${dateFilter}&order=date.desc&limit=2000`;

                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                allData = data.reverse(); // Oldest to newest for charts
                
                updateStats();
                updateAllCharts();
                updateTable();
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

            } catch (error) {
                console.error('Error fetching data:', error);
                document.querySelector('.charts-section').innerHTML = 
                    `<div class="error">‚ùå Error loading data: ${error.message}</div>`;
            }
        }

        // Update Statistics
        function updateStats() {
            if (allData.length === 0) return;

            const latest = allData[allData.length - 1];
            const previous = allData[allData.length - 2] || latest;

            // Total Subscribers
            document.getElementById('totalSubscribers').textContent = formatNumber(latest.tips_subscribers);
            const subsChange = latest.tips_subscribers - previous.tips_subscribers;
            document.getElementById('subsChange').textContent = `${subsChange >= 0 ? '+' : ''}${formatNumber(subsChange)}`;
            document.getElementById('subsChange').className = subsChange >= 0 ? 'change' : 'change negative';

            // Total Views
            document.getElementById('totalViews').textContent = formatNumber(latest.tips_views);
            const viewsChange = latest.tips_views - previous.tips_views;
            document.getElementById('viewsChange').textContent = `${viewsChange >= 0 ? '+' : ''}${formatNumber(viewsChange)}`;
            document.getElementById('viewsChange').className = viewsChange >= 0 ? 'change' : 'change negative';

            // Daily Views
            document.getElementById('dailyViews').textContent = formatNumber(latest.daily_views_change || 0);
            const dailyChange = (latest.daily_views_change || 0) - (previous.daily_views_change || 0);
            document.getElementById('dailyViewsChange').textContent = `${dailyChange >= 0 ? '+' : ''}${formatNumber(dailyChange)}`;
            document.getElementById('dailyViewsChange').className = dailyChange >= 0 ? 'change' : 'change negative';

            // Stock Price
            document.getElementById('stockPrice').textContent = formatCurrency(latest.stock_price || 0);
            const stockChange = (latest.stock_price || 0) - (previous.stock_price || 0);
            const stockChangePct = previous.stock_price ? (stockChange / previous.stock_price * 100) : 0;
            document.getElementById('stockChange').textContent = `${stockChange >= 0 ? '+' : ''}${formatCurrency(stockChange)} (${stockChangePct.toFixed(2)}%)`;
            document.getElementById('stockChange').className = stockChange >= 0 ? 'change' : 'change negative';
        }

        // Chart Updates
        function updateViewsChart() {
            const dates = allData.map(d => d.date);
            const dailyViews = allData.map(d => d.daily_views_change || 0);
            const showMA = document.getElementById('showViewsMA').checked;

            const traces = [{
                x: dates,
                y: dailyViews,
                type: 'scatter',
                mode: 'lines',
                name: 'Daily Views',
                line: { color: '#667eea', width: 2 }
            }];

            if (showMA) {
                const ma7 = calculateMA(dailyViews, 7);
                const ma30 = calculateMA(dailyViews, 30);
                const ma45 = calculateMA(dailyViews, 45);

                traces.push({
                    x: dates,
                    y: ma7,
                    type: 'scatter',
                    mode: 'lines',
                    name: '7-Day MA',
                    line: { color: '#ffa500', width: 1.5, dash: 'dash' }
                });

                traces.push({
                    x: dates,
                    y: ma30,
                    type: 'scatter',
                    mode: 'lines',
                    name: '30-Day MA',
                    line: { color: '#28a745', width: 2 }
                });

                traces.push({
                    x: dates,
                    y: ma45,
                    type: 'scatter',
                    mode: 'lines',
                    name: '45-Day MA',
                    line: { color: '#dc3545', width: 2 }
                });
            }

            const layout = {
                yaxis: { 
                    type: viewsScaleType,
                    title: 'Daily Views',
                    gridcolor: '#e0e0e0'
                },
                xaxis: { 
                    title: 'Date',
                    gridcolor: '#e0e0e0'
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: { orientation: 'h', y: -0.2 },
                margin: { t: 20, b: 60, l: 60, r: 20 }
            };

            Plotly.newPlot('dailyViewsChart', traces, layout, {responsive: true});
        }

        function updateStockChart() {
            const dates = allData.map(d => d.date);
            const stockPrices = allData.map(d => d.stock_price || null);
            const showMA = document.getElementById('showStockMA').checked;

            const traces = [{
                x: dates,
                y: stockPrices,
                type: 'scatter',
                mode: 'lines',
                name: 'Stock Price',
                line: { color: '#1e3c72', width: 2 }
            }];

            if (showMA) {
                const ma7 = calculateMA(stockPrices, 7);
                const ma30 = calculateMA(stockPrices, 30);
                const ma45 = calculateMA(stockPrices, 45);

                traces.push({
                    x: dates,
                    y: ma7,
                    type: 'scatter',
                    mode: 'lines',
                    name: '7-Day MA',
                    line: { color: '#ffa500', width: 1.5, dash: 'dash' }
                });

                traces.push({
                    x: dates,
                    y: ma30,
                    type: 'scatter',
                    mode: 'lines',
                    name: '30-Day MA',
                    line: { color: '#28a745', width: 2 }
                });

                traces.push({
                    x: dates,
                    y: ma45,
                    type: 'scatter',
                    mode: 'lines',
                    name: '45-Day MA',
                    line: { color: '#dc3545', width: 2 }
                });
            }

            const layout = {
                yaxis: { 
                    type: stockScaleType,
                    title: 'Price (‚Çπ)',
                    gridcolor: '#e0e0e0'
                },
                xaxis: { 
                    title: 'Date',
                    gridcolor: '#e0e0e0'
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: { orientation: 'h', y: -0.2 },
                margin: { t: 20, b: 60, l: 60, r: 20 }
            };

            Plotly.newPlot('stockPriceChart', traces, layout, {responsive: true});
        }

        function updateMonthlyGrowthChart() {
            const monthlyData = {};
            
            allData.forEach(d => {
                const month = d.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = [];
                }
                monthlyData[month].push(d.daily_views_change || 0);
            });

            const months = Object.keys(monthlyData).sort();
            const monthlyTotals = months.map(m => 
                monthlyData[m].reduce((a, b) => a + b, 0)
            );

            const trace = {
                x: months,
                y: monthlyTotals,
                type: 'bar',
                marker: { 
                    color: monthlyTotals.map(v => v >= 0 ? '#28a745' : '#dc3545')
                },
                text: monthlyTotals.map(v => formatNumber(v)),
                textposition: 'outside'
            };

            const layout = {
                yaxis: { 
                    title: 'Total Monthly Views',
                    gridcolor: '#e0e0e0'
                },
                xaxis: { 
                    title: 'Month',
                    gridcolor: '#e0e0e0'
                },
                showlegend: false,
                margin: { t: 20, b: 60, l: 80, r: 20 }
            };

            Plotly.newPlot('monthlyGrowthChart', [trace], layout, {responsive: true});
        }

        function updateDualAxisChart() {
            const dates = allData.map(d => d.date);
            const dailyViews = allData.map(d => d.daily_views_change || 0);
            const stockPrices = allData.map(d => d.stock_price || null);

            let viewsData, viewsName, stockData, stockName;

            if (dualAxisMode === 'raw') {
                viewsData = dailyViews;
                viewsName = 'Daily Views';
                stockData = stockPrices;
                stockName = 'Stock Price';
            } else if (dualAxisMode === 'ma30') {
                viewsData = calculateMA(dailyViews, 30);
                viewsName = '30-Day MA (Views)';
                stockData = stockPrices;
                stockName = 'Stock Price';
            } else if (dualAxisMode === 'ma45') {
                viewsData = calculateMA(dailyViews, 45);
                viewsName = '45-Day MA (Views)';
                stockData = stockPrices;
                stockName = 'Stock Price';
            } else if (dualAxisMode === 'ma45_stock') {
                viewsData = calculateMA(dailyViews, 45);
                viewsName = '45-Day MA (Views)';
                stockData = calculateMA(stockPrices, 45);
                stockName = '45-Day MA (Stock)';
            }

            const trace1 = {
                x: dates,
                y: viewsData,
                type: 'scatter',
                mode: 'lines',
                name: viewsName,
                line: { color: '#667eea', width: 2.5 },
                yaxis: 'y'
            };

            const trace2 = {
                x: dates,
                y: stockData,
                type: 'scatter',
                mode: 'lines',
                name: stockName,
                line: { color: '#dc3545', width: 2.5 },
                yaxis: 'y2'
            };

            const layout = {
                yaxis: {
                    title: viewsName,
                    titlefont: { color: '#667eea' },
                    tickfont: { color: '#667eea' },
                    gridcolor: '#e0e0e0'
                },
                yaxis2: {
                    title: stockName + ' (‚Çπ)',
                    titlefont: { color: '#dc3545' },
                    tickfont: { color: '#dc3545' },
                    overlaying: 'y',
                    side: 'right'
                },
                xaxis: { 
                    title: 'Date',
                    gridcolor: '#e0e0e0'
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: { orientation: 'h', y: -0.2 },
                margin: { t: 20, b: 60, l: 80, r: 80 }
            };

            Plotly.newPlot('dualAxisChart', [trace1, trace2], layout, {responsive: true});
        }

        function updateAllCharts() {
            updateViewsChart();
            updateStockChart();
            updateMonthlyGrowthChart();
            updateDualAxisChart();
        }

        // Toggle Functions
        function toggleViewsScale(scale) {
            viewsScaleType = scale;
            document.querySelectorAll('#dailyViewsChart').forEach(el => {
                el.parentElement.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            });
            event.target.classList.add('active');
            updateViewsChart();
        }

        function toggleStockScale(scale) {
            stockScaleType = scale;
            document.querySelectorAll('#stockPriceChart').forEach(el => {
                el.parentElement.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            });
            event.target.classList.add('active');
            updateStockChart();
        }

        function toggleDualAxisMode(mode) {
            dualAxisMode = mode;
            document.querySelectorAll('#dualAxisChart').forEach(el => {
                el.parentElement.querySelectorAll('.toggle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            });
            event.target.classList.add('active');
            updateDualAxisChart();
        }

        // Table Functions
        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = allData.slice().reverse().slice(start, end);

            tbody.innerHTML = '';

            pageData.forEach((row, idx) => {
                const prevRow = allData.slice().reverse()[start + idx + 1];
                const viewsChange = prevRow ? (row.daily_views_change || 0) - (prevRow.daily_views_change || 0) : 0;
                const viewsChangePct = prevRow && prevRow.daily_views_change ? 
                    (viewsChange / prevRow.daily_views_change * 100) : 0;
                const stockChange = prevRow && prevRow.stock_price ? 
                    (row.stock_price || 0) - (prevRow.stock_price || 0) : 0;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${formatNumber(row.daily_views_change || 0)}</td>
                    <td style="color: ${viewsChange >= 0 ? '#28a745' : '#dc3545'}">${viewsChange >= 0 ? '+' : ''}${formatNumber(viewsChange)}</td>
                    <td style="color: ${viewsChangePct >= 0 ? '#28a745' : '#dc3545'}">${viewsChangePct.toFixed(2)}%</td>
                    <td>${formatCurrency(row.stock_price || 0)}</td>
                    <td style="color: ${stockChange >= 0 ? '#28a745' : '#dc3545'}">${stockChange >= 0 ? '+' : ''}${formatCurrency(stockChange)}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pageInfo').textContent = 
                `Showing ${start + 1}-${Math.min(end, allData.length)} of ${allData.length} records`;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }

        function nextPage() {
            if (currentPage * rowsPerPage < allData.length) {
                currentPage++;
                updateTable();
            }
        }

        function refreshData() {
            currentPage = 1;
            fetchData();
        }

        // Initialize
        window.onload = () => {
            fetchData();
        };
    </script>
</body>
</html>
